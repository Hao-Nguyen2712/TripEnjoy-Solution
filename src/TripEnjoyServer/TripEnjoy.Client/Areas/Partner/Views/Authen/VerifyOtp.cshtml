@model TripEnjoy.Client.ViewModels.VerifyOtpRequestVM
@{
    ViewData["Title"] = "Verify OTP - Partner";
}

<div class="d-flex flex-column h-100 p-3">
    <div class="d-flex flex-column flex-grow-1">
        <div class="row h-100">
            <div class="col-xxl-7">
                <div class="row justify-content-center h-100">
                    <div class="col-lg-6 py-lg-5">
                        <div class="d-flex flex-column h-100 justify-content-center">
                            <div class="auth-logo mb-4">
                                <a href="/" class="logo-dark">
                                    <img src="~/img/logo-dark.png" height="24" alt="logo dark">
                                </a>
                                <a href="/" class="logo-light">
                                    <img src="~/img/logo-light.png" height="24" alt="logo light">
                                </a>
                            </div>

                            <h2 class="fw-bold fs-24">Verify Your Identity</h2>
                            <p class="text-muted mt-1 mb-4">
                                We've sent a verification code to <strong>@Model.Email</strong>. 
                                Please enter the code below to complete your partner sign-in.
                            </p>

                            <div>
                                <form method="post" asp-action="VerifyOtp" asp-controller="Authen" asp-area="Partner">
                                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                                    <input type="hidden" asp-for="Email" />

                                    <div class="mb-4">
                                        <label asp-for="Otp" class="form-label">Verification Code</label>
                                        <input asp-for="Otp" class="form-control text-center" 
                                               placeholder="Enter 6-digit code" 
                                               maxlength="6" 
                                               style="font-size: 1.5rem; letter-spacing: 0.5rem; font-weight: bold;">
                                        <span asp-validation-for="Otp" class="text-danger"></span>
                                    </div>

                                    <div class="mb-4 text-center">
                                        <div class="alert alert-info">
                                            <i class="fas fa-clock me-2"></i>
                                            Code expires in <span id="countdown">5:00</span>
                                        </div>
                                    </div>

                                    <div class="mb-3 text-center d-grid">
                                        <button type="submit" class="btn btn-soft-primary">
                                            <i class="fas fa-check me-2"></i>Verify & Sign In
                                        </button>
                                    </div>
                                </form>

                                <div class="text-center mt-3">
                                    <p class="text-muted">Didn't receive the code?</p>
                                    <button class="btn btn-link" id="resend-code" disabled>
                                        <i class="fas fa-redo me-2"></i>Resend Code
                                    </button>
                                </div>

                                <div class="text-center mt-4">
                                    <a href="/partner/auth/sign-in" class="text-muted">
                                        <i class="fas fa-arrow-left me-2"></i>Back to Sign In
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xxl-5 d-none d-xxl-flex">
                    <div class="card h-100 mb-0 overflow-hidden">
                        <div class="d-flex flex-column h-100">
                            <img src="~/img/small/img-3.jpg" alt="" class="w-100 h-100">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function () {
            const notyf = new Notyf({
                duration: 5000,
                position: { x: 'right', y: 'top' },
                types: [
                    { type: 'error', background: '#FA5252' },
                    { type: 'success', background: '#3D7BFD' }
                ]
            });

            // Display ModelState errors
            @if (!ViewData.ModelState.IsValid)
            {
                foreach (var key in ViewData.ModelState.Keys)
                {
                    foreach (var error in ViewData.ModelState[key].Errors)
                    {
                        <text>notyf.error('@Html.Raw(System.Web.HttpUtility.JavaScriptStringEncode(error.ErrorMessage))');</text>
                    }
                }
            }

            // OTP Input Enhancement
            const otpInput = $('#Otp');
            otpInput.on('input', function() {
                // Only allow numbers
                this.value = this.value.replace(/[^0-9]/g, '');
                
                // Auto-submit when 6 digits entered
                if (this.value.length === 6) {
                    $(this).closest('form').submit();
                }
            });

            // Countdown Timer
            let timeLeft = 300; // 5 minutes in seconds
            const countdownElement = $('#countdown');
            const resendButton = $('#resend-code');

            function updateCountdown() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                countdownElement.text(`${minutes}:${seconds.toString().padStart(2, '0')}`);
                
                if (timeLeft === 0) {
                    countdownElement.parent().removeClass('alert-info').addClass('alert-warning');
                    countdownElement.parent().html('<i class="fas fa-exclamation-triangle me-2"></i>Code has expired');
                    resendButton.prop('disabled', false).removeClass('btn-link').addClass('btn-warning');
                    clearInterval(timer);
                } else {
                    timeLeft--;
                }
            }

            const timer = setInterval(updateCountdown, 1000);
            updateCountdown(); // Initial call

            // Resend Code (placeholder - you can implement this later)
            resendButton.on('click', function() {
                notyf.success('New verification code sent to your email');
                // Reset timer
                timeLeft = 300;
                $(this).prop('disabled', true).removeClass('btn-warning').addClass('btn-link');
                countdownElement.parent().removeClass('alert-warning').addClass('alert-info');
                clearInterval(timer);
                const newTimer = setInterval(updateCountdown, 1000);
            });

            // Clear timer if specified by server
            @if (TempData["ClearOtpTimer"] != null)
            {
                <text>clearInterval(timer);</text>
            }
        });
    </script>
}

@section Styles {
    <style>
        .alert-info {
            background-color: #e7f3ff;
            border-color: #b8daff;
            color: #0c5460;
        }

        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        #Otp:focus {
            box-shadow: 0 0 0 0.2rem rgba(61, 123, 253, 0.25);
            border-color: #3d7bfd;
        }
    </style>
}