@page "/partner/properties/{PropertyId:guid}/room-types"
@inject IRoomTypeService RoomTypeService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Room Types - TripEnjoy</PageTitle>

<AuthorizeView Roles="Partner" Context="authContext">
    <Authorized>
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
            <MudPaper Elevation="3" Class="pa-6">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h4">Room Types</MudText>
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.Add"
                              Href="@($"/partner/properties/{PropertyId}/room-types/create")">
                        Add Room Type
                    </MudButton>
                </MudStack>

                @if (_isLoading)
                {
                    <MudProgressCircular Indeterminate="true" />
                }
                else if (_roomTypes == null || !_roomTypes.Any())
                {
                    <MudAlert Severity="Severity.Info">
                        No room types found. Click "Add Room Type" to create one.
                    </MudAlert>
                }
                else
                {
                    <MudGrid>
                        @foreach (var roomType in _roomTypes)
                        {
                            <MudItem xs="12" sm="6" md="4">
                                <MudCard Elevation="2">
                                    <MudCardMedia Image="@GetMainImage(roomType)" Height="200" />
                                    <MudCardContent>
                                        <MudText Typo="Typo.h6">@roomType.RoomTypeName</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            @roomType.Description
                                        </MudText>
                                        <MudStack Row="true" Class="mt-2">
                                            <MudChip Size="Size.Small" Color="Color.Info" T="string">
                                                Capacity: @roomType.Capacity
                                            </MudChip>
                                            <MudChip Size="Size.Small" Color="Color.Success" T="string">
                                                $@roomType.BasePrice
                                            </MudChip>
                                            <MudChip Size="Size.Small" Color="Color.Warning" T="string">
                                                Qty: @roomType.TotalQuantity
                                            </MudChip>
                                        </MudStack>
                                    </MudCardContent>
                                    <MudCardActions>
                                        <MudButton Size="Size.Small" 
                                                  Color="Color.Primary"
                                                  Href="@($"/partner/properties/{PropertyId}/room-types/edit/{roomType.Id}")">
                                            Edit
                                        </MudButton>
                                        <MudButton Size="Size.Small" 
                                                  Color="Color.Error"
                                                  OnClick="@(() => DeleteRoomType(roomType.Id))">
                                            Delete
                                        </MudButton>
                                    </MudCardActions>
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                }
            </MudPaper>
        </MudContainer>
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public Guid PropertyId { get; set; }

    private List<RoomTypeDto> _roomTypes = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoomTypes();
    }

    private async Task LoadRoomTypes()
    {
        _isLoading = true;
        var result = await RoomTypeService.GetRoomTypesByPropertyAsync(PropertyId);
        
        if (result.IsSuccess && result.Data != null)
        {
            _roomTypes = result.Data;
        }
        else
        {
            Snackbar.Add(result.Message ?? "Failed to load room types", Severity.Error);
        }
        
        _isLoading = false;
    }

    private string GetMainImage(RoomTypeDto roomType)
    {
        var mainImage = roomType.Images.FirstOrDefault(i => i.IsMain);
        return mainImage?.FilePath ?? "https://via.placeholder.com/300x200?text=No+Image";
    }

    private async Task DeleteRoomType(Guid roomTypeId)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete Room Type",
            "Are you sure you want to delete this room type?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            var result = await RoomTypeService.DeleteRoomTypeAsync(roomTypeId);
            
            if (result.IsSuccess)
            {
                Snackbar.Add("Room type deleted successfully", Severity.Success);
                await LoadRoomTypes();
            }
            else
            {
                Snackbar.Add(result.Message ?? "Failed to delete room type", Severity.Error);
            }
        }
    }
}
