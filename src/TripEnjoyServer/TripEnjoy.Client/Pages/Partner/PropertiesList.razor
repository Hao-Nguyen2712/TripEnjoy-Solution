@page "/partner/properties"
@inject IPropertyService PropertyService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>My Properties - TripEnjoy</PageTitle>

<AuthorizeView Roles="Partner" Context="authContext">
    <Authorized>
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                <MudText Typo="Typo.h4">My Properties</MudText>
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.Add"
                          OnClick="NavigateToCreate">
                    Add Property
                </MudButton>
            </MudStack>

            @if (_isLoading)
            {
                <MudProgressCircular Indeterminate="true" />
            }
            else if (_properties.Any())
            {
                <MudTable Items="_properties" Hover="true" Dense="true">
                    <HeaderContent>
                        <MudTh>Name</MudTh>
                        <MudTh>Location</MudTh>
                        <MudTh>Type</MudTh>
                        <MudTh>Rating</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Name">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                @if (!string.IsNullOrEmpty(@context.CoverImageUrl))
                                {
                                    <MudAvatar Size="Size.Medium" Image="@context.CoverImageUrl" />
                                }
                                else
                                {
                                    <MudAvatar Size="Size.Medium" Icon="@Icons.Material.Filled.Home" Color="Color.Primary" />
                                }
                                <MudText Typo="Typo.body1">@context.Name</MudText>
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="Location">
                            <MudText Typo="Typo.body2">@context.City, @context.Country</MudText>
                        </MudTd>
                        <MudTd DataLabel="Type">
                            <MudChip T="string" Size="Size.Small" Color="Color.Info">@context.PropertyTypeName</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Rating">
                            @if (context.AverageRating.HasValue)
                            {
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudRating ReadOnly="true" SelectedValue="@((int)context.AverageRating.Value)" MaxValue="5" Size="Size.Small" />
                                    <MudText Typo="Typo.caption">@context.AverageRating.Value.ToString("0.0")</MudText>
                                </MudStack>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">No reviews</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Actions">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                           Color="Color.Primary"
                                           OnClick="@(() => NavigateToDetails(context.Id))"
                                           Title="View" />
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Secondary"
                                           OnClick="@(() => NavigateToEdit(context.Id))"
                                           Title="Edit" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info">
                    You haven't added any properties yet. Click "Add Property" to create your first listing.
                </MudAlert>
            }
        </MudContainer>
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<PropertySummaryDto> _properties = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadProperties();
    }

    private async Task LoadProperties()
    {
        _isLoading = true;
        try
        {
            var result = await PropertyService.GetMyPropertiesAsync();
            if (result.IsSuccess && result.Data != null)
            {
                _properties = result.Data;
            }
            else
            {
                Snackbar.Add(result.Message ?? "Failed to load your properties", Severity.Error);
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void NavigateToCreate()
    {
        NavigationManager.NavigateTo("/partner/properties/create");
    }

    private void NavigateToEdit(Guid propertyId)
    {
        NavigationManager.NavigateTo($"/partner/properties/edit/{propertyId}");
    }

    private void NavigateToDetails(Guid propertyId)
    {
        NavigationManager.NavigateTo($"/properties/{propertyId}");
    }
}
