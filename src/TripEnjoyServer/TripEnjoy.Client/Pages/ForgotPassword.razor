@page "/forgot-password"
@inject IAuthenticationService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Forgot Password - TripEnjoy</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudPaper Elevation="4" Class="pa-8">
        <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">Reset Your Password</MudText>
        <MudText Typo="Typo.body1" Align="Align.Center" Class="mb-6">
            Enter your email and we'll send you a verification code
        </MudText>

        @if (!_otpSent && string.IsNullOrEmpty(_resetToken))
        {
            <!-- Step 1: Request OTP -->
            <EditForm Model="@_forgotPasswordModel" OnValidSubmit="HandleForgotPassword">
                <DataAnnotationsValidator />
                <MudTextField @bind-Value="_forgotPasswordModel.Email" 
                             Label="Email" 
                             Variant="Variant.Outlined" 
                             InputType="InputType.Email"
                             Required="true"
                             Class="mb-4" />
                <MudButton ButtonType="ButtonType.Submit" 
                          Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          FullWidth="true"
                          Disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    }
                    else
                    {
                        <span>Send Verification Code</span>
                    }
                </MudButton>
            </EditForm>
        }
        else if (_otpSent && string.IsNullOrEmpty(_resetToken))
        {
            <!-- Step 2: Verify OTP -->
            <EditForm Model="@_verifyOtpModel" OnValidSubmit="HandleVerifyOtp">
                <DataAnnotationsValidator />
                <MudText Typo="Typo.body2" Class="mb-4">
                    A verification code has been sent to your email. Please enter it below.
                </MudText>
                <MudTextField @bind-Value="_verifyOtpModel.Otp" 
                             Label="Verification Code" 
                             Variant="Variant.Outlined" 
                             Required="true"
                             Class="mb-4" />
                <MudButton ButtonType="ButtonType.Submit" 
                          Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          FullWidth="true"
                          Disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    }
                    else
                    {
                        <span>Verify Code</span>
                    }
                </MudButton>
                <MudButton OnClick="@(() => { _otpSent = false; _verifyOtpModel.Otp = string.Empty; })" 
                          Variant="Variant.Text" 
                          Color="Color.Default" 
                          FullWidth="true"
                          Class="mt-2">
                    Back
                </MudButton>
            </EditForm>
        }
        else if (!string.IsNullOrEmpty(_resetToken))
        {
            <!-- Step 3: Reset Password -->
            <EditForm Model="@_resetPasswordModel" OnValidSubmit="HandleResetPassword">
                <DataAnnotationsValidator />
                <MudText Typo="Typo.body2" Class="mb-4">
                    Enter your new password below.
                </MudText>
                <MudTextField @bind-Value="_resetPasswordModel.NewPassword" 
                             Label="New Password" 
                             Variant="Variant.Outlined" 
                             InputType="InputType.Password"
                             Required="true"
                             Class="mb-4" />
                <MudTextField @bind-Value="_resetPasswordModel.ConfirmPassword" 
                             Label="Confirm Password" 
                             Variant="Variant.Outlined" 
                             InputType="InputType.Password"
                             Required="true"
                             Class="mb-4" />
                <MudText Typo="Typo.caption" Class="mb-4">
                    Password must be at least 8 characters with uppercase, lowercase, digit, and special character.
                </MudText>
                <MudButton ButtonType="ButtonType.Submit" 
                          Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          FullWidth="true"
                          Disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    }
                    else
                    {
                        <span>Reset Password</span>
                    }
                </MudButton>
            </EditForm>
        }

        <MudDivider Class="my-4" />
        <MudLink Href="/login">Back to Login</MudLink>
    </MudPaper>
</MudContainer>

@code {
    private ForgotPasswordRequest _forgotPasswordModel = new();
    private VerifyPasswordResetOtpRequest _verifyOtpModel = new();
    private ResetPasswordRequest _resetPasswordModel = new();
    private bool _otpSent = false;
    private string _resetToken = string.Empty;
    private bool _isLoading = false;

    private async Task HandleForgotPassword()
    {
        _isLoading = true;
        try
        {
            var result = await AuthService.ForgotPasswordAsync(_forgotPasswordModel);
            if (result.IsSuccess)
            {
                _verifyOtpModel.Email = _forgotPasswordModel.Email;
                _otpSent = true;
                Snackbar.Add("Verification code sent to your email", Severity.Success);
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleVerifyOtp()
    {
        _isLoading = true;
        try
        {
            var result = await AuthService.VerifyPasswordResetOtpAsync(_verifyOtpModel);
            if (result.IsSuccess && !string.IsNullOrEmpty(result.Data))
            {
                _resetToken = result.Data;
                _resetPasswordModel.Email = _verifyOtpModel.Email;
                _resetPasswordModel.ResetToken = _resetToken;
                Snackbar.Add("Code verified! Please enter your new password.", Severity.Success);
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleResetPassword()
    {
        if (_resetPasswordModel.NewPassword != _resetPasswordModel.ConfirmPassword)
        {
            Snackbar.Add("Passwords do not match", Severity.Error);
            return;
        }

        _isLoading = true;
        try
        {
            var result = await AuthService.ResetPasswordAsync(_resetPasswordModel);
            if (result.IsSuccess)
            {
                Snackbar.Add("Password reset successful! You can now login with your new password.", Severity.Success);
                NavigationManager.NavigateTo("/login");
            }
            else
            {
                var errorMessage = result.Errors?.Any() == true 
                    ? string.Join(", ", result.Errors) 
                    : result.Message;
                Snackbar.Add(errorMessage, Severity.Error);
            }
        }
        finally
        {
            _isLoading = false;
        }
    }
}
