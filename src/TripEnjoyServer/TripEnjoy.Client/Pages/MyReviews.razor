@page "/reviews/my-reviews"
@inject IReviewService ReviewService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize(Roles = "User")]

<PageTitle>My Reviews - TripEnjoy</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h4">My Reviews</MudText>
        <MudButton Variant="Variant.Filled" 
                 Color="Color.Primary" 
                 Href="/reviews/create"
                 StartIcon="@Icons.Material.Filled.Add">
            Write a Review
        </MudButton>
    </MudStack>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (_reviews.Any())
    {
        <MudGrid>
            @foreach (var review in _reviews)
            {
                <MudItem xs="12">
                    <MudCard Elevation="3">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                    <MudStack>
                                        <MudText Typo="Typo.h6">@review.RoomTypeName</MudText>
                                        <MudRating ReadOnly="true" SelectedValue="@review.Rating" Size="Size.Small" />
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @review.CreatedAt.ToString("MMM dd, yyyy")
                                        </MudText>
                                    </MudStack>
                                    <MudStack Row="true" Spacing="2">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                     Color="Color.Primary" 
                                                     Size="Size.Small"
                                                     OnClick="@(() => EditReview(review))" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                     Color="Color.Error" 
                                                     Size="Size.Small"
                                                     OnClick="@(() => DeleteReview(review.Id))" />
                                    </MudStack>
                                </MudStack>

                                <MudText Typo="Typo.body2">@review.Comment</MudText>

                                @if (review.Images.Any())
                                {
                                    <MudStack Row="true" Spacing="2">
                                        @foreach (var image in review.Images.Take(5))
                                        {
                                            <MudImage Src="@image.FilePath" 
                                                    Height="100" 
                                                    Width="100" 
                                                    ObjectFit="ObjectFit.Cover" 
                                                    Class="rounded" />
                                        }
                                    </MudStack>
                                }

                                @if (review.Status != "Active")
                                {
                                    <MudChip T="string" Color="Color.Warning" Size="Size.Small">
                                        Status: @review.Status
                                    </MudChip>
                                }

                                @if (review.Replies.Any())
                                {
                                    <MudDivider Class="my-2" />
                                    <MudText Typo="Typo.subtitle2">Replies:</MudText>
                                    @foreach (var reply in review.Replies)
                                    {
                                        <MudPaper Elevation="0" Class="pa-2" Style="background-color: #f5f5f5;">
                                            <MudText Typo="Typo.caption" Color="Color.Primary">
                                                <strong>@reply.ReplierName</strong> (@reply.ReplierType)
                                            </MudText>
                                            <MudText Typo="Typo.body2">@reply.Content</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @reply.CreatedAt.ToString("MMM dd, yyyy")
                                            </MudText>
                                        </MudPaper>
                                    }
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        @if (_pagedResult != null && _pagedResult.TotalPages > 1)
        {
            <MudPagination Class="mt-4" 
                          Count="@_pagedResult.TotalPages" 
                          Selected="@_currentPage" 
                          SelectedChanged="OnPageChanged" />
        }
    }
    else
    {
        <MudPaper Elevation="3" Class="pa-8" Style="text-align: center;">
            <MudIcon Icon="@Icons.Material.Filled.RateReview" Size="Size.Large" Color="Color.Secondary" Class="mb-4" />
            <MudText Typo="Typo.h6" Class="mb-2">No reviews yet</MudText>
            <MudText Typo="Typo.body2" Class="mb-4">Complete your stays and share your experiences!</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/reviews/create">Write a Review</MudButton>
        </MudPaper>
    }
</MudContainer>

<!-- Edit Review Dialog -->
<MudDialog @bind-IsVisible="_showEditDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">Edit Review</MudText>
    </TitleContent>
    <DialogContent>
        @if (_editingReview != null)
        {
            <MudStack Spacing="3">
                <MudStack>
                    <MudText Typo="Typo.subtitle1">Rating</MudText>
                    <MudRating @bind-SelectedValue="_editRating" Size="Size.Large" />
                </MudStack>

                <MudTextField @bind-Value="_editComment" 
                            Label="Your Review" 
                            Variant="Variant.Outlined" 
                            Lines="5"
                            Counter="1000"
                            MaxLength="1000" />
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CancelEdit">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                 Variant="Variant.Filled" 
                 OnClick="SaveEdit"
                 Disabled="@_isUpdating">
            @if (_isUpdating)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
            }
            else
            {
                <span>Save</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<ReviewDto> _reviews = new();
    private PagedList<ReviewDto>? _pagedResult;
    private bool _isLoading = true;
    private int _currentPage = 1;
    private int _pageSize = 10;
    private Guid _userId = Guid.Empty;

    // Edit dialog
    private bool _showEditDialog = false;
    private ReviewDto? _editingReview = null;
    private int _editRating = 5;
    private string _editComment = string.Empty;
    private bool _isUpdating = false;

    protected override async Task OnInitializedAsync()
    {
        await GetUserId();
        await LoadReviews();
    }

    private async Task GetUserId()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst("sub") ?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var userId))
            {
                _userId = userId;
            }
        }
    }

    private async Task LoadReviews()
    {
        if (_userId == Guid.Empty)
        {
            Snackbar.Add("Unable to identify user", Severity.Error);
            return;
        }

        _isLoading = true;
        try
        {
            var result = await ReviewService.GetUserReviewsAsync(_userId, _currentPage, _pageSize);
            if (result.IsSuccess && result.Data != null)
            {
                _pagedResult = result.Data;
                _reviews = result.Data.Items;
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadReviews();
    }

    private void EditReview(ReviewDto review)
    {
        _editingReview = review;
        _editRating = review.Rating;
        _editComment = review.Comment;
        _showEditDialog = true;
    }

    private void CancelEdit()
    {
        _showEditDialog = false;
        _editingReview = null;
    }

    private async Task SaveEdit()
    {
        if (_editingReview == null) return;

        if (string.IsNullOrWhiteSpace(_editComment) || _editComment.Length < 10)
        {
            Snackbar.Add("Review must be at least 10 characters", Severity.Warning);
            return;
        }

        _isUpdating = true;
        try
        {
            var request = new UpdateReviewRequest
            {
                ReviewId = _editingReview.Id,
                Rating = _editRating,
                Comment = _editComment
            };

            var result = await ReviewService.UpdateReviewAsync(_editingReview.Id, request);
            if (result.IsSuccess)
            {
                Snackbar.Add("Review updated successfully", Severity.Success);
                _showEditDialog = false;
                await LoadReviews();
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
        finally
        {
            _isUpdating = false;
        }
    }

    private async Task DeleteReview(Guid reviewId)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete Review",
            "Are you sure you want to delete this review? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                var result = await ReviewService.DeleteReviewAsync(reviewId);
                if (result.IsSuccess)
                {
                    Snackbar.Add("Review deleted successfully", Severity.Success);
                    await LoadReviews();
                }
                else
                {
                    Snackbar.Add(result.Message, Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting review: {ex.Message}", Severity.Error);
            }
        }
    }
}
