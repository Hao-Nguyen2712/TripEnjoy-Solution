@page "/properties/{PropertyId:guid}"
@inject IPropertyService PropertyService
@inject IReviewService ReviewService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>@_property?.Name - TripEnjoy</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (_property == null)
    {
        <MudAlert Severity="Severity.Error">Property not found</MudAlert>
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudPaper Elevation="3" Class="pa-4">
                    @if (_property.Images.Any())
                    {
                        <MudCarousel TData="object" Style="height:400px;" ShowArrows="true" ShowBullets="true" EnableSwipeGesture="true" AutoCycle="false">
                            @foreach (var image in _property.Images)
                            {
                                <MudCarouselItem>
                                    <img src="@image.ImageUrl" style="width:100%; height:400px; object-fit:cover;" alt="@_property.Name" />
                                </MudCarouselItem>
                            }
                        </MudCarousel>
                    }
                    else
                    {
                        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="height: 400px; background-color: #f0f0f0;">
                            <MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Large" Color="Color.Default" />
                            <MudText Typo="Typo.body1">No images available</MudText>
                        </MudStack>
                    }

                    <MudStack Class="mt-4">
                        <MudText Typo="Typo.h4">@_property.Name</MudText>
                        <MudText Typo="Typo.body1" Color="Color.Secondary">
                            <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" />
                            @_property.Address, @_property.City, @_property.Country
                        </MudText>
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small">@_property.PropertyTypeName</MudChip>
                            <MudChip T="string" Color="Color.Info" Size="Size.Small">@_property.Status</MudChip>
                            @if (_property.AverageRating.HasValue)
                            {
                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                    <MudRating ReadOnly="true" SelectedValue="@((int)_property.AverageRating.Value)" Size="Size.Small" />
                                    <MudText Typo="Typo.body2">(@_property.ReviewCount reviews)</MudText>
                                </MudStack>
                            }
                        </MudStack>

                        @if (!string.IsNullOrEmpty(_property.Description))
                        {
                            <MudDivider Class="my-4" />
                            <MudText Typo="Typo.h6">Description</MudText>
                            <MudText Typo="Typo.body1">@_property.Description</MudText>
                        }
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">Book This Property</MudText>
                    <AuthorizeView Roles="User">
                        <Authorized>
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Primary" 
                                      FullWidth="true"
                                      OnClick="BookProperty">
                                Book Now
                            </MudButton>
                        </Authorized>
                        <NotAuthorized>
                            <MudAlert Severity="Severity.Info">Please login as a user to book this property</MudAlert>
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Primary" 
                                      FullWidth="true"
                                      Href="/login"
                                      Class="mt-2">
                                Login to Book
                            </MudButton>
                        </NotAuthorized>
                    </AuthorizeView>
                </MudPaper>

                <MudPaper Elevation="3" Class="pa-4 mt-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">Property Information</MudText>
                    <MudStack Spacing="3">
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Small" />
                            <MudText Typo="Typo.body2">Type: @_property.PropertyTypeName</MudText>
                        </MudStack>
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.LocationCity" Size="Size.Small" />
                            <MudText Typo="Typo.body2">City: @_property.City</MudText>
                        </MudStack>
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" />
                            <MudText Typo="Typo.body2">Country: @_property.Country</MudText>
                        </MudStack>
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                            <MudText Typo="Typo.body2">Listed: @_property.CreatedAt.ToString("MMM dd, yyyy")</MudText>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Reviews Section -->
        <MudDivider Class="my-6" />
        <MudText Typo="Typo.h5" Class="mb-4">Guest Reviews</MudText>
        
        @if (_loadingReviews)
        {
            <MudProgressCircular Indeterminate="true" Size="Size.Small" />
        }
        else if (_reviews.Any())
        {
            <MudGrid>
                @foreach (var review in _reviews)
                {
                    <MudItem xs="12">
                        <MudCard Elevation="2" Class="mb-3">
                            <MudCardContent>
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                    <MudStack>
                                        <MudText Typo="Typo.subtitle1"><strong>@review.UserName</strong></MudText>
                                        <MudRating ReadOnly="true" SelectedValue="@review.Rating" Size="Size.Small" />
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @review.CreatedAt.ToString("MMM dd, yyyy")
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                                <MudText Typo="Typo.body2" Class="mt-2">@review.Comment</MudText>
                                
                                @if (review.Images.Any())
                                {
                                    <MudStack Row="true" Class="mt-2" Spacing="2">
                                        @foreach (var image in review.Images.Take(3))
                                        {
                                            <MudImage Src="@image.FilePath" 
                                                    Height="80" 
                                                    Width="80" 
                                                    ObjectFit="ObjectFit.Cover" 
                                                    Class="rounded" />
                                        }
                                    </MudStack>
                                }

                                @if (review.Replies.Any())
                                {
                                    <MudDivider Class="my-2" />
                                    @foreach (var reply in review.Replies)
                                    {
                                        <MudPaper Elevation="0" Class="pa-2 mt-2" Style="background-color: #f5f5f5;">
                                            <MudText Typo="Typo.caption" Color="Color.Primary">
                                                <strong>@reply.ReplierName</strong> (@reply.ReplierType)
                                            </MudText>
                                            <MudText Typo="Typo.body2">@reply.Content</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @reply.CreatedAt.ToString("MMM dd, yyyy")
                                            </MudText>
                                        </MudPaper>
                                    }
                                }
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>

            @if (_reviewsPagedResult != null && _reviewsPagedResult.TotalPages > 1)
            {
                <MudPagination Class="mt-4" 
                              Count="@_reviewsPagedResult.TotalPages" 
                              Selected="@_reviewsPage" 
                              SelectedChanged="OnReviewsPageChanged" />
            }
        }
        else
        {
            <MudAlert Severity="Severity.Info">No reviews yet. Be the first to review this property!</MudAlert>
        }
    }
</MudContainer>

@code {
    [Parameter]
    public Guid PropertyId { get; set; }

    private PropertyDto? _property;
    private bool _isLoading = true;
    private List<ReviewDto> _reviews = new();
    private PagedList<ReviewDto>? _reviewsPagedResult;
    private bool _loadingReviews = false;
    private int _reviewsPage = 1;
    private int _reviewsPageSize = 5;

    protected override async Task OnInitializedAsync()
    {
        await LoadProperty();
        await LoadReviews();
    }

    private async Task LoadProperty()
    {
        _isLoading = true;
        try
        {
            var result = await PropertyService.GetPropertyByIdAsync(PropertyId);
            if (result.IsSuccess && result.Data != null)
            {
                _property = result.Data;
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadReviews()
    {
        _loadingReviews = true;
        try
        {
            var result = await ReviewService.GetReviewsByPropertyAsync(PropertyId, _reviewsPage, _reviewsPageSize);
            if (result.IsSuccess && result.Data != null)
            {
                _reviewsPagedResult = result.Data;
                _reviews = result.Data.Items;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading reviews: {ex.Message}", Severity.Warning);
        }
        finally
        {
            _loadingReviews = false;
        }
    }

    private async Task OnReviewsPageChanged(int page)
    {
        _reviewsPage = page;
        await LoadReviews();
    }

    private void BookProperty()
    {
        NavigationManager.NavigateTo($"/bookings/create/{PropertyId}");
    }
}
